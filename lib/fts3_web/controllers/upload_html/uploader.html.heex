<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fts3 - S3 Bucket File Uploader</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
    <main class="main">

        <div class="centerCard">

            <h1 class="titleHeader">S3 Bucket File Uploader</h1>

            <div class="cardContent">


                <div class="fileSelector">
                    <h2 class="selectFile">Press here to select File</h2>
                    <input class="fileinput" type="file" id="fileInput">
                </div>


                <div class="rightItems">
                    <button id="uploadBtn" style="padding: 10px 20px; border-radius: 8px; background: #8b9cff; color: #0f1430; border: none; font-weight: 600; cursor: pointer;">Upload File</button>
                    <div id="status" hidden>
                        <h2 class="panelTitle">Upload Status</h2>
                        <p id="statusText">Ready</p>
                        <div class="progressBar">
                            <div id="progressFill"></div>
                        </div>
                        <p id="progressText">0%</p>
                        <p id="uploadSpeed">Speed: 0 MB/s</p>
                    </div>

                    <div id="result" hidden>
                        <h2 class="panelTitle">Result:</h2>
                        <p id="resultText"></p>
                        <div id="urlContainer" hidden>
                            <h3 class="panelSubtitle">File Access URL</h3>
                            <input type="text" id="publicUrl" readonly>
                            <button id="copyUrlBtn">Copy URL</button>
                            <a id="downloadBtn" href="#" target="_blank">Open Link</a>
                        </div>
                    </div>
                </div>

            </div>

            <script>
                const CHUNK_SIZE = 5 * 1024 * 1024;
                const MAX_RETRIES = 3;
                const RETRY_DELAY = 1000;

                const fileInput = document.getElementById('fileInput');
                const uploadBtn = document.getElementById('uploadBtn');
                const status = document.getElementById('status');
                const statusText = document.getElementById('statusText');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const uploadSpeed = document.getElementById('uploadSpeed');
                const result = document.getElementById('result');
                const resultText = document.getElementById('resultText');

                uploadBtn.addEventListener('click', function () {
                    const file = fileInput.files[0];
                    if (!file) {
                        alert('Please select a file');
                        return;
                    }
                    if (file.size === 0) {
                        alert('File is empty');
                        return;
                    }

                    status.hidden = false;
                    result.hidden = true;
                    uploadFile(file);
                });

                function uploadFile(file) {
                    const uploadId = generateUploadId();
                    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                    let uploadedChunks = 0;
                    let startTime = Date.now();

                    statusText.textContent = `Uploading ${file.name} (${formatBytes(file.size)}) in ${totalChunks} chunks...`;

                    function uploadChunk(chunkIndex, retryCount = 0) {
                        const start = chunkIndex * CHUNK_SIZE;
                        const end = Math.min(start + CHUNK_SIZE, file.size);
                        const chunk = file.slice(start, end);

                        const formData = new FormData();
                        formData.append('chunk', chunk);
                        formData.append('chunk_number', chunkIndex);
                        formData.append('total_chunks', totalChunks);
                        formData.append('upload_id', uploadId);
                        formData.append('filename', file.name);

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);

                        fetch('/upload', {
                            method: 'POST',
                            body: formData,
                            signal: controller.signal
                        })
                            .then(response => {
                                clearTimeout(timeoutId);
                                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) throw new Error(data.error);

                                uploadedChunks++;
                                const progress = (uploadedChunks / totalChunks) * 100;
                                progressFill.style.width = progress + '%';
                                progressText.textContent = progress.toFixed(1) + '%';

                                const elapsedSeconds = (Date.now() - startTime) / 1000;
                                const uploadedBytes = uploadedChunks * CHUNK_SIZE;
                                const speed = elapsedSeconds > 0 ? uploadedBytes / elapsedSeconds / (1024 * 1024) : 0;
                                uploadSpeed.textContent = `Speed: ${speed.toFixed(2)} MB/s`;

                                statusText.textContent = `Chunk ${uploadedChunks} of ${totalChunks} complete`;

                                if (uploadedChunks < totalChunks) {
                                    uploadChunk(uploadedChunks);
                                } else {
                                    const elapsedMs = Date.now() - startTime;
                                    const totalMB = file.size / (1024 * 1024);
                                    const avgSpeed = (totalMB / elapsedMs) * 1000;
                                    statusText.textContent = `Upload complete: ${file.name}`;
                                    resultText.textContent = `Successfully uploaded ${file.name}. Size: ${formatBytes(file.size)}. Avg Speed: ${avgSpeed.toFixed(2)} MB/s`;
                                    result.hidden = false;

                                    if (data.public_url) {
                                        const urlInput = document.getElementById('publicUrl');
                                        const downloadBtn = document.getElementById('downloadBtn');
                                        urlInput.value = data.public_url;
                                        downloadBtn.href = data.public_url;
                                        document.getElementById('urlContainer').hidden = false;
                                    }
                                }
                            })
                            .catch(error => {
                                clearTimeout(timeoutId);
                                const errorMsg = error.name === 'AbortError' ? 'Request timeout' : error.message;

                                if (retryCount < MAX_RETRIES) {
                                    statusText.textContent = `Retrying chunk ${chunkIndex + 1}...`;
                                    setTimeout(() => uploadChunk(chunkIndex, retryCount + 1), RETRY_DELAY * (retryCount + 1));
                                } else {
                                    statusText.textContent = `Failed to upload chunk ${chunkIndex + 1}`;
                                    resultText.textContent = `Upload failed: ${errorMsg}`;
                                    result.hidden = false;
                                }
                            });
                    }

                    uploadChunk(0);
                }

                function generateUploadId() {
                    return 'upload_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }

                function formatBytes(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
                }

                document.getElementById('copyUrlBtn').addEventListener('click', function () {
                    const urlInput = document.getElementById('publicUrl');
                    navigator.clipboard.writeText(urlInput.value).then(() => {
                        this.textContent = 'Copied!';
                        setTimeout(() => { this.textContent = 'Copy URL'; }, 2000);
                    });
                });
            </script>
        </div>
        
    </main>
    <div class="footer">
        <p><a href="https://github.com/jam06452/FTS3">Made with ❤️ by jam06452</a> <br> and ui by <a href="https://tomwebsites.nl">Tom de Jong</a></p>
    </div>
</body>

</html>
